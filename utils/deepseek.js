const axios = require('axios');

// Функция для вызова DeepSeek API
async function callDeepSeek(prompt, maxTokens = 4000) {
  try {
    const response = await axios.post('https://api.deepseek.com/v1/chat/completions', {
      model: 'deepseek-chat',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.7,
      max_tokens: maxTokens
    }, {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`
      }
    });

    return response.data.choices[0].message.content;
  } catch (error) {
    console.error('Ошибка при вызове DeepSeek API:', error.response?.data || error.message);
    throw new Error(`Ошибка API: ${error.response?.data?.error?.message || error.message}`);
  }
}

// Функция для анализа текста с использованием Chain of Thoughts
async function analyzeWithDeepSeek(text) {
  try {
    // Шаг 0: Инициализация и контекст
    const step0Prompt = `Ты — опытный аналитик академических текстов и эксперт в области академической добросовестности. Твоя задача — проанализировать предоставленную студенческую работу, выступая в роли ассистента преподавателя. Твой анализ должен быть максимально объективным и опираться на наблюдаемые признаки.

Ключевые принципы:
- Гипотетичность: Все твои выводы — это обоснованные гипотезы, а не окончательные обвинения. Избегай категоричных формулировок.
- Доказательность: Каждое утверждение должно подкрепляться конкретными примерами из текста (цитатами).
- Контекстуальность: Учитывай, что некоторые признаки ИИ (например, гладкость) могут быть признаком просто хорошо написанной работы, а стилистические сдвиги — следствием редактирования или использования разных источников.

Задачи анализа:
- Выявить потенциальные заимствования (плагиат) из известных источников.
- Определить признаки, указывающие на возможную генерацию текста с помощью ИИ.
- Обнаружить стилистические и композиционные аномалии, указывающие на неоднородность авторства.
- Сформировать структурированный отчет с рекомендациями для дальнейших действий преподавателя.

Текст для анализа:
${text}

Подготовься к анализу. Опиши свой подход к анализу этого текста.`;

    const step0Result = await callDeepSeek(step0Prompt, 1000);
    
    // Шаг 1: Преанализ и сегментация
    const step1Prompt = `Шаг 1: Преанализ и сегментация

Перед анализом подготовь текст. Твоя первоочередная задача — разделить предоставленную работу на 10-20 относительно равных по смысловой нагрузке блоков.

Текст для анализа:
${text}

Определи контекст: Укажи предполагаемую дисциплину, уровень сложности работы и ее жанр.
Выполни детальную сегментацию: Разбей текст на логические блоки по критериям:
- Каждый блок должен содержать одну ключевую мысль, аргумент или пример.
- Разделяй длинные абзацы на несколько блоков по изменению темы или аргумента.
- Для коротких работ разделяй даже короткие абзацы на отдельные предложения-блоки, если они несут самостоятельную смысловую нагрузку.
- Присвой каждому блоку уникальный ID (Блок 1, Блок 2... Блок N).

Результат представь в виде таблицы: | ID блока (от 1 до N) | Текст блока (первые 5-7 слов) | Основная тема/тезис |`;

    const step1Result = await callDeepSeek(step1Prompt, 3000);
    
    // Шаг 2: Анализ признаков генерации ИИ
    const step2Prompt = `Шаг 2: Анализ признаков генерации ИИ

Для каждого смыслового блока проанализируй наличие стилистических и содержательных маркеров, характерных для текстов, сгенерированных ИИ. Для каждого признака приведи конкретную цитату-пример из текста.

Текст для анализа:
${text}

Оцени вероятность того, что блок был сгенерирован ИИ (P_ai) по шкале от 0 до 1. Ищи следующие признаки:

Признаки ВЫСОКОЙ вероятности (P_ai > 0.7):
- Генерализация и отсутствие специфики: Текст гладкий, но лишен глубоких деталей, уникальных примеров, ссылок на конкретные данные, личный опыт или нюансы.
- Шаблонная структура и логика: Использование предсказуемых связок («Таким образом», «Важно отметить, что», «В заключении следует сказать»), общих мест и линейной, непротиворечивой аргументации без неожиданных поворотов.
- «Стеклянная» безупречность: Полное отсутствие опечаток, грамматических ошибок, стилистических шероховатостей и idiosyncrasies (индивидуальных особенностей стиля).
- Риск-аверсия: Текст избегает смелых, спорных или оригинальных утверждений, предпочитая безопасные, общепринятые точки зрения.
- Иллюзия содержания: Утверждения декларативны и звучат убедительно, но не подкреплены конкретными данными, примерами или глубоким анализом («поверхностная глубина»).
- Анахронизмы или контекстуальные ошибки: Использование терминов или концепций, не соответствующих заявленному контексту или дисциплине.

Признаки НИЗКОЙ вероятности (P_ai < 0.3):
- Наличие личных размышлений, уникальных примеров, гипотез, вопросов, нетривиальных аналогии.
- Специфический профессиональный жаргон, использованный уместно и нешаблонно.
- Неидеальность: мелкие ошибки, исправления, особенности авторского стиля, эмоциональные оценки.
- Сложная, нелинейная аргументация с допущениями и их проверкой.

Результат представь в виде таблицы: | ID блока | Цитата-пример | Признаки ИИ (высок./низк.) | Вероятность P_ai |`;

    const step2Result = await callDeepSeek(step2Prompt, 4000);
    
    // Шаг 3: Семантический анализ на заимствования и плагиат
    const step3Prompt = `Шаг 3: Семантический анализ на заимствования и плагиат

Текст для анализа:
${text}

Для каждого смыслового блока оцени вероятность заимствования (Pз) по шкале от 0 до 1.

Общеизвестное знание: Если информация является общеизвестным фактом в данной области (например, «Вода кипит при 100°C»), оцени Pз как 0. Не требует указания источника.

Специализированное знание: Если информация узкоспециализированна (теории, концепции, данные, конкретные аргументы):
- Попробуй идентифицировать потенциальный источник: Используй свои знания, чтобы определить, знаком ли тебе этот набор идей, уникальных формулировок или структуры аргументации из академических источников (учебников, статей, лекций). Если источник точно неизвестен, предложи гипотетический тип источника (напр., «учебник по макроэкономике», «статья о теории игр»).
- Оцени тип заимствования:
  - Pз ~1.0: Высокая вероятность дословного заимствования (узнаваемая уникальная формулировка, конструкция). Приведи цитату.
  - Pз ~0.6-0.8: Вероятность перефразирования (рерайта) идеи или структуры аргументации без цитирования.
  - Pз ~0.3-0.5: Возможное заимствование общей идеи без конкретных формулировок.
  - Pз ~0.1-0.2: Оригинальное изложение или корректное цитирование общедоступного знания.

Результат представь в виде таблицы: | ID блока | Основная тема | Цитата-пример | Потенциальный источник/Тип источника | Вероятность Pз |`;

    const step3Result = await callDeepSeek(step3Prompt, 4000);
    
    // Шаг 4: Стилистический анализ на аномалии
    const step4Prompt = `Шаг 4: Стилистический анализ на аномалии

Текст для анализа:
${text}

Проанализируй весь документ на предмет стилистической согласованности. Оцени степень стилистической аномалии (Sa) для каждого блока по шкале от 0 до 1 относительно общего стиля документа.

Ищи резкие изменения в:
- Сложности предложений: Внезапное упрощение или усложнение синтаксиса.
- Лексике: Появление или исчезновение профессионального жаргона, изменение тона (научный -> разговорный), использование слов-паразитов.
- Narrative voice: Изменение от третьего лица к первому или наоборот.
- Грамматических и пунктуационных паттернах: Изменение patterns оформления списков, использования тире/двоеточий и т.д.

Результат представь в виде таблицы: | ID блока | Описание аномалии (с примером) | Степень аномалии (Sa) |`;

    const step4Result = await callDeepSeek(step4Prompt, 4000);
    
    // Шаг 5: Расчет итогового индекса академического риска (ИАР)
    const step5Prompt = `Шаг 5: Расчет итогового индекса академического риска (ИАР)

На основе предыдущих анализов (шаги 2-4) для каждого блока рассчитай Итоговый Индекс Академического Риска (ИАР) по формуле:
ИАР = (W_з * Pз) + (W_ai * P_ai) + (W_a * Sa)

Где:
- Pз — Вероятность заимствования (из Шага 3).
- P_ai — Вероятность генерации ИИ (из Шага 2).
- Sa — Степень стилистической аномалии (из Шага 4).
- W_з, W_ai, W_a — Весовые коэффициенты. Используй: W_з = 0.4, W_ai = 0.4, W_a = 0.2.

Результат представь в итоговой сводной таблице: | ID блока | Тема | Pз | P_ai | Sa | ИАР |`;

    const step5Result = await callDeepSeek(step5Prompt, 3000);
    
    // Шаг 6: Формирование итогового отчета для преподавателя
    const step6Prompt = `Шаг 6: Формирование итогового отчета для преподавателя

На основе проведенного анализа сформируй итоговый отчет для преподавателя. Используй четкие заголовки и списки.

Текст для анализа:
${text}

Результаты предыдущих шагов доступны для анализа.

1. Резюме анализа
   - Общий ИАР документа: (Среднее значение ИАР по всем блокам). Интерпретация:
     - Низкий риск (ИАР < 0.3): Незначительные признаки, вероятно, ложные срабатывания.
     - Средний риск (0.3 ≤ ИАР ≤ 0.6): Наличие подозрительных элементов, требующих ручной проверки.
     - Высокий риск (ИАР > 0.6): Сильные признаки недобросовестности.
   - Гипотетическое заключение: Кратко опиши наиболее вероятный сценарий происхождения текста.

2. Детализация по блокам высокого риска (TOP-3)
   Для каждого из 3-х блоков с наивысшим ИАР предоставь:
   - ID блока и его тему.
   - Значения Pз, P_ai, Sa.
   - Конкретные выдержки из текста, вызвавшие подозрения.
   - Краткий вывод.

3. Рекомендации к действиу
   - Для проверки на плагиат
   - Для проверки на использование ИИ
   - Для стилистических аномалий

4. Важные замечания
   - Напомни, что анализ является гипотетическим и нуждается в дальнейшей проверке.
   - Укажи, что весовые коэффициенты (W) были приняты по умолчанию и могут быть скорректированы.`;

    const step6Result = await callDeepSeek(step6Prompt, 4000);
    
    return {
      step0: step0Result,
      step1: step1Result,
      step2: step2Result,
      step3: step3Result,
      step4: step4Result,
      step5: step5Result,
      step6: step6Result
    };
  } catch (error) {
    console.error('Ошибка при анализе с DeepSeek:', error);
    throw error;
  }
}

module.exports = { analyzeWithDeepSeek };